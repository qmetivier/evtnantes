<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>commits-example</title>
  <style>
    #demo {
      font-family: 'Helvetica', Arial, sans-serif;
    }

    .event_div[actif="false"]{
      display: inline-block;
      width: 300px;
      border: 1px solid black;
      padding: 10px;
      margin: 10px;
    }

    a {
      text-decoration: none;
      color: #f66;
    }
    .author, .date {
      font-weight: bold;
    }

    img{
      width: 60px;
      height: 60px;
    }
  </style>
</head>
<body>
<div id="demo">
  <h1>Dernier évènement sur Nantes</h1>
  <button v-on:click="setTypeList()">Changer le type d'affichage</button>
  <input type="text"  v-model="query">
  <div>
      <event-div v-for="event in commits" v-bind:event ="event" v-bind:list="list" :key="event.recordid"/>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  var apiURL = 'https://data.nantesmetropole.fr/api/records/1.0/search/?dataset=244400404_agenda-evenements-nantes-nantes-metropole&facet=emetteur&facet=rubrique&facet=lieu&facet=ville&q='

  /**
   * Actual demo
   */

  Vue.component('EventDiv', {
    props: {
      event: null,
      list: String
    },

    template: "<div class='event_div' :actif='list'>" +
            "      <a :href=\"event.fields.lien_agenda\" target=\"_blank\" class=\"commit\">{{ event.fields.nom }}</a>\n" +
            "      <img :src=\"event.fields.media_1\" alt=\"\" >\n" +
            "      <br>\n" +
            "      - <span class=\"message\">{{ event.fields.description | truncate }}</span><br>\n" +
            "      PAR : <span class=\"author\">{{ event.fields.emetteur }}</span>\n" +
            "      <br>" +
            "      LE : <span class=\"date\">{{ event.fields.date | formatDate }}</span>" +
              "</div>",

    filters: {
      truncate: function (v) {
        var newline = v.indexOf('\n')
        return newline > 0 ? v.slice(0, newline) : v
      },
      formatDate: function (v) {
        return v.replace(/T|Z/g, ' ')
      }
    }
  })

  var demo = new Vue({

    el: '#demo',

    data: {
      commits: null,
      list: "true",
      query: ""
    },

    created: function () {
      this.fetchData()
    },

    watch: {
      query: 'fetchData'
    },

    methods: {
      setTypeList : function(){
        this.list = (this.list === "true") ? "false" : "true";
      },

      fetchData: function () {
        console.log(apiURL + this.query);
        axios.get(apiURL + this.query)
                .then( res => {
                  console.log(res.data.records);
                  this.commits = res.data.records;
                })
                .catch( err => {
                  console.log(err);
                });
      }
    }
  })
</script>
</body>
</html>